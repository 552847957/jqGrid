!function(r){"use strict";"function"==typeof define&&define.amd?define(["jquery","./grid.base"],r):"object"==typeof module&&module.exports?module.exports=function(e,o){return e||(e=window),void 0===o&&(o="undefined"!=typeof window?require("jquery"):require("jquery")(e)),require("./grid.base"),r(o),o}:r(jQuery)}(function(r){"use strict";var e=r.jgrid,o=r.fn.jqGrid;e.extend({groupingSetup:function(){return this.each(function(){var i,t,n,a,l,u=this.p,s=u.colModel,d=u.groupingView,p=function(){return""};if(null===d||"object"!=typeof d&&!r.isFunction(d))u.grouping=!1;else if(d.groupField.length){for(void 0===d.visibiltyOnNextGrouping&&(d.visibiltyOnNextGrouping=[]),d.lastvalues=[],d._locgr||(d.groups=[]),d.counters=[],i=0;i<d.groupField.length;i++)d.groupOrder[i]||(d.groupOrder[i]="asc"),d.groupText[i]||(d.groupText[i]="{0}"),"boolean"!=typeof d.groupColumnShow[i]&&(d.groupColumnShow[i]=!0),"boolean"!=typeof d.groupSummary[i]&&(d.groupSummary[i]=!1),d.groupSummaryPos[i]||(d.groupSummaryPos[i]="footer"),a=s[u.iColByName[d.groupField[i]]],!0===d.groupColumnShow[i]?(d.visibiltyOnNextGrouping[i]=!0,null!=a&&!0===a.hidden&&o.showCol.call(r(this),d.groupField[i])):(d.visibiltyOnNextGrouping[i]=r("#"+e.jqID(u.id+"_"+d.groupField[i])).is(":visible"),null!=a&&!0!==a.hidden&&o.hideCol.call(r(this),d.groupField[i]));for(d.summary=[],d.hideFirstGroupCol&&(d.formatDisplayField[0]=function(r){return r}),t=0,n=s.length;t<n;t++)a=s[t],d.hideFirstGroupCol&&(a.hidden||d.groupField[0]!==a.name||(a.formatter=p)),a.summaryType&&(l={nm:a.name,st:a.summaryType,v:"",sr:a.summaryRound,srt:a.summaryRoundType||"round"},a.summaryDivider&&(l.sd=a.summaryDivider,l.vd=""),d.summary.push(l))}else u.grouping=!1})},groupingPrepare:function(e,i){return this.each(function(){var t,n,a,l,u,s,d,p,g,m=this,f=m.p,c=f.groupingView,h=c.groups,y=c.counters,v=c.lastvalues,x=c.isInTheSameGroup,w=c.groupField.length,F=!1,C=o.groupingCalculations.handler,j=function(){var o,i,t;for(o=0;o<u.summary.length;o++)i=u.summary[o],t=r.isArray(i.st)?i.st[l.idx]:i.st,r.isFunction(t)?i.v=t.call(m,i.v,i.nm,e,l):(i.v=C.call(r(m),t,i.v,i.nm,i.sr,i.srt,e),"avg"===t.toLowerCase()&&i.sd&&(i.vd=C.call(r(m),t,i.vd,i.sd,i.sr,i.srt,e)));return u.summary},b=function(e,o){if(null==e&&c.useDefaultValuesOnGrouping){var i,t=void 0!==f.iColByName[o]?f.colModel[f.iColByName[o]]:f.additionalProperties[f.iPropByName[o]];null!=t&&null!=t.formatter&&(null!=t.formatoptions&&void 0!==t.formatoptions.defaultValue?e=t.formatoptions.defaultValue:"string"==typeof t.formatter&&void 0!==(i=r(m).jqGrid("getGridRes","formatter."+t.formatter+".defaultValue"))&&(e=i))}return e};for(t=0;t<w;t++)if(s=c.groupField[t],d=b(e[s],s),d,p=c.displayField[t],null==(g=null==p?null:b(e[p],p))&&(g=d),void 0!==d){for(a=[],n=0;n<=t;n++)a.push(e[c.groupField[n]]);for(l={idx:t,dataIndex:s,value:d,displayValue:g,startRow:i,cnt:1,keys:a,summary:[]},u={cnt:1,pos:h.length,summary:r.extend(!0,[],c.summary)},0===i?(h.push(l),v[t]=d,y[t]=u):"object"==typeof d||(r.isArray(x)&&r.isFunction(x[t])?x[t].call(m,v[t],d,t,c):v[t]===d)?F?(h.push(l),v[t]=d,y[t]=u):((u=y[t]).cnt+=1,h[u.pos].cnt=u.cnt):(h.push(l),v[t]=d,F=!0,y[t]=u),h[u.pos].summary=j(),n=u.pos-1;n>=0;n--)if(h[n].idx<h[u.pos].idx){h[u.pos].parentGroupIndex=n,h[u.pos].parentGroup=h[n];break}}}),this},getGroupHeaderIndex:function(o,i){var t=this[0].p,n=i?r(i).closest("tr.jqgroup"):r("#"+e.jqID(o)),a=parseInt(n.data("jqgrouplevel"),10),l=t.id+"ghead_"+a+"_";return isNaN(a)||!n.hasClass("jqgroup")||o.length<=l.length?-1:parseInt(o.substring(l.length),10)},groupingToggle:function(o,i){return this.each(function(){var t,n,a,l=this.p,u=l.groupingView,s=u.minusicon,d=u.plusicon,p=i?r(i).closest("tr.jqgroup"):r("#"+e.jqID(o)),g=function(r){return r.find(">td>span.tree-wrap")},m=!0,f=!1,c=[],h=function(r){var e,o=r.length;for(e=0;e<o;e++)c.push(r[e])},y=parseInt(p.data("jqgrouplevel"),10);for(l.frozenColumns&&p.length>0&&(n=p[0].rowIndex,p=(p=r(this.rows[n])).add(this.grid.fbRows[n])),a=g(p),e.hasAllClasses(a,s)?(a.removeClass(s).addClass(d),f=!0):a.removeClass(d).addClass(s),p=p.next();p.length;p=p.next())if(p.hasClass("jqfoot")){if(t=parseInt(p.data("jqfootlevel"),10),f){if(t=parseInt(p.data("jqfootlevel"),10),(!u.showSummaryOnHide&&t===y||t>y)&&h(p),t<y)break}else if((t===y||u.showSummaryOnHide&&t===y+1)&&h(p),t<=y)break}else if(p.hasClass("jqgroup"))if(t=parseInt(p.data("jqgrouplevel"),10),f){if(t<=y)break;h(p)}else{if(t<=y)break;t===y+1&&(g(p).removeClass(s).addClass(d),h(p)),m=!1}else(f||m)&&h(p);r(c).css("display",f?"none":""),l.frozenColumns&&r(this).triggerHandler("jqGridResetFrozenHeights",[{header:{resizeDiv:!1,resizedRows:{iRowStart:-1,iRowEnd:-1}},resizeFooter:!1,body:{resizeDiv:!0,resizedRows:{iRowStart:n,iRowEnd:p.length?p[0].rowIndex-1:-1}}}]),this.fixScrollOffsetAndhBoxPadding(),r(this).triggerHandler("jqGridGroupingClickGroup",[o,f]),r.isFunction(l.onClickGroup)&&l.onClickGroup.call(this,o,f)}),!1},groupingRender:function(i,t){function n(o,i,t,n,a){var s,d,g,m,y,v,x,w,F,C,j,b,q,G=f[o],S="",R=0,N=!0;if(0!==i&&0!==f[o].idx)for(s=o;s>=0;s--)if(f[s].idx===f[o].idx-i){G=f[s];break}for(d=G.cnt,j=void 0===a?n:0;j<h;j++){for(g="&#160;",C=c[j],w=0;w<G.summary.length;w++)if(F=G.summary[w],b=r.isArray(F.st)?F.st[t.idx]:F.st,q=r.isArray(C.summaryTpl)?C.summaryTpl[t.idx]:C.summaryTpl||"{0}",F.nm===C.name){"string"==typeof b&&"avg"===b.toLowerCase()&&(F.sd&&F.vd?F.v=F.v/F.vd:F.v&&d>0&&(F.v=F.v/d));try{F.groupCount=G.cnt,F.groupIndex=G.dataIndex,F.groupValue=G.value,v=l.formatter("",F.v,j,F)}catch(r){v=F.v}g=e.format(q,v),C.summaryFormat&&(g=C.summaryFormat.call(l,t,g,v,C,F));break}m=!1,y=!1,void 0!==a&&N&&(C.hidden||(g=a,N=!1,n>1&&(m=!0,R=n-1),y=C.align,C.align="rtl"===u.direction?"right":"left",p.iconColumnName=C.name)),x=!1,R>0&&!C.hidden&&"&#160;"===g?(x=!0,y&&(C.align=y),R--):(S+="<td role='gridcell' "+l.formatCol(j,1,"")+(m?"colspan='"+n+"'":"")+">"+g+"</td>",m=!1,y&&(C.align=y),x&&(C.hidden=!1,R--))}return S}var a="",l=this[0],u=l.p,s=0,d=[],p=u.groupingView,g=r.makeArray(p.groupSummary),m=p.groupField.length,f=p.groups,c=u.colModel,h=c.length,y=u.page,v="jqGridShowHideCol.groupingRender",x=function(r){return o.getGuiStyles.call(l,"gridRow",r)},w=x("jqgroup ui-row-"+u.direction),F=x("jqfoot ui-row-"+u.direction);return r.each(c,function(r,e){var o;for(o=0;o<m;o++)if(p.groupField[o]===e.name){d[o]=r;break}}),g.reverse(),r.each(f,function(o,v){var x,C,j,b,q,G,S,R,N=u.id+"ghead_"+v.idx,I=N+"_"+o,V=r.isFunction(p.groupCollapse)?p.groupCollapse.call(l,{group:v,rowid:I}):p.groupCollapse,O=1,k=0,T=m-1===v.idx,D=null!=v.parentGroup&&v.parentGroup.collapsed,P="<span style='cursor:pointer;margin-"+("rtl"===u.direction?"right:":"left:")+12*v.idx+"px;' class='"+p.commonIconClass+" "+(V?p.plusicon:p.minusicon)+" tree-wrap'></span>";if(p._locgr&&!(v.startRow+v.cnt>(y-1)*t&&v.startRow<y*t))return!0;D&&(V=!0),void 0!==V&&(v.collapsed=V),s++;try{r.isArray(p.formatDisplayField)&&r.isFunction(p.formatDisplayField[v.idx])?(v.displayValue=p.formatDisplayField[v.idx].call(l,v.displayValue,v.value,c[d[v.idx]],v.idx,p),x=v.displayValue):x=l.formatter(I,v.displayValue,d[v.idx],v.value)}catch(r){x=v.displayValue}if(a+="<tr id='"+I+"' data-jqgrouplevel='"+v.idx+"' "+(V&&D?"style='display:none;' ":"")+"role='row' class='"+w+" "+N+"'>","string"!=typeof(R=r.isFunction(p.groupText[v.idx])?p.groupText[v.idx].call(l,x,v.cnt,v.summary):e.template(p.groupText[v.idx],x,v.cnt,v.summary))&&"number"!=typeof R&&(R=x),"header"===p.groupSummaryPos[v.idx]?(O=1,"cb"!==c[0].name&&"cb"!==c[1].name||O++,"subgrid"!==c[0].name&&"subgrid"!==c[1].name||O++,a+=n(o,0,v,O,P+"<span class='cell-wrapper'>"+R+"</span>")):a+="<td role='gridcell' style='padding-left:"+12*v.idx+"px;' colspan='"+h+"'>"+P+R+"</td>",a+="</tr>",T){for(G=f[o+1],q=v.startRow,S=void 0!==G?G.startRow:f[o].startRow+f[o].cnt,p._locgr&&(k=(y-1)*t)>v.startRow&&(q=k),j=q;j<S&&i[j-k];j++)a+=i[j-k].join("");if("header"!==p.groupSummaryPos[v.idx]){if(void 0!==G){for(C=0;C<p.groupField.length&&G.dataIndex!==p.groupField[C];C++);s=p.groupField.length-C}for(b=0;b<s;b++)g[b]&&(a+="<tr data-jqfootlevel='"+(v.idx-b)+(V&&(v.idx-b>0||!p.showSummaryOnHide)?"' style='display:none;'":"'")+" role='row' class='"+F+"'>",a+=n(o,b,f[v.idx-b],0),a+="</tr>");s=C}}}),this.off(v).on(v,function(){var e,o,i,t,n=u.iColByName[p.iconColumnName];if(r.inArray("header",p.groupSummaryPos)>=0){for(t=0;t<c.length;t++)if(!c[t].hidden){i=t;break}if(void 0===i||n===i)return;for(e=0;e<l.rows.length;e++)o=l.rows[e],r(o).hasClass("jqgroup")&&(r(o.cells[i]).html(o.cells[n].innerHTML),r(o.cells[n]).html("&nbsp;"));p.iconColumnName=c[i].name}}),a},groupingGroupBy:function(i,t){return this.each(function(){var n,a,l=this.p,u=l.groupingView;for("string"==typeof i&&(i=[i]),l.grouping=!0,u._locgr=!1,void 0===u.visibiltyOnNextGrouping&&(u.visibiltyOnNextGrouping=[]),n=0;n<u.groupField.length;n++)a=l.colModel[l.iColByName[u.groupField[n]]],!u.groupColumnShow[n]&&u.visibiltyOnNextGrouping[n]&&null!=a&&!0===a.hidden&&o.showCol.call(r(this),u.groupField[n]);for(n=0;n<i.length;n++)u.visibiltyOnNextGrouping[n]=r(l.idSel+"_"+e.jqID(i[n])).is(":visible");l.groupingView=r.extend(l.groupingView,t||{}),u.groupField=i,r(this).trigger("reloadGrid")})},groupingRemove:function(e){return this.each(function(){var i,t=this.p,n=this.tBodies[0],a=t.groupingView;if(void 0===e&&(e=!0),t.grouping=!1,!0===e){for(i=0;i<a.groupField.length;i++)!a.groupColumnShow[i]&&a.visibiltyOnNextGrouping[i]&&o.showCol.call(r(this),a.groupField);r("tr.jqgroup, tr.jqfoot",n).remove(),r("tr.jqgrow",n).filter(":hidden").show()}else r(this).trigger("reloadGrid")})},groupingCalculations:{handler:function(r,e,o,i,t,n){var a,l,u={sum:function(){return parseFloat(e||0)+parseFloat(n[o]||0)},min:function(){return""===e?parseFloat(n[o]||0):Math.min(parseFloat(e),parseFloat(n[o]||0))},max:function(){return""===e?parseFloat(n[o]||0):Math.max(parseFloat(e),parseFloat(n[o]||0))},count:function(){return""===e&&(e=0),n.hasOwnProperty(o)?e+1:0},avg:function(){return u.sum()}};if(!u[r])throw"jqGrid Grouping No such method: "+r;return a=u[r](),null!=i&&("fixed"===t?a=a.toFixed(i):(l=Math.pow(10,i),a=Math.round(a*l)/l)),a}}})});
//# sourceMappingURL=grid.grouping.js.map